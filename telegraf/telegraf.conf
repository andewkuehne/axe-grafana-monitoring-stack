# telegraf.conf

# --- Global Agent Configuration ---
[agent]
  # Poll every 10 minutes (or as desired)
  interval = "10m"
  round_interval = true
  flush_interval = "10m"
  flush_jitter = "2s"
  hostname = "telegraf-miner-poller"

# --- Output: InfluxDB ---
[[outputs.influxdb_v2]]
  # Use the Docker service name 'influxdb'
  urls = ["http://influxdb:8086"]
  
  # Use environment variables passed from docker-compose
  token = "${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}"
  organization = "${DOCKER_INFLUXDB_INIT_ORG}"
  bucket = "${DOCKER_INFLUXDB_INIT_BUCKET}"

# --- Input: HTTP Poller ---
# This ONE input polls our new web app
[[inputs.http]]
  # Poll the /metrics endpoint on our new service
  urls = [
    "http://miner-manager:5000/metrics"
  ]
  
  # Set a longer timeout, as the app has to poll all miners
  timeout = "30s"
  
  # The data coming from our app is already in Influx Line Protocol
  data_format = "influx"